/*
Copyright (c) 2011-2012 Johannes Mitlmeier

This file is part of Jazzy.

Jazzy is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/agpl.html>.
*/
var borderXSize=50;var borderYSize=50;var fontWidth=100;var globalScalingFactor=2;var dragZoomFactor=1.5;var spriteOrder="kqrbnpcih";var highlightType={LAST_MOVE:1,SELECTION:2};function BoardStorage(){this.boards=new Object()}BoardStorage.prototype.newBoard=function(e,b,d,c){var a=new Board(e,b,d,c);this.boards[e]=a;return a};BoardStorage.prototype.getBoard=function(a){if(this.boards[a]!==undefined){return this.boards[a]}return undefined};function Board(h,d,g,e){var c=document.createElement("canvas");if(!c.getContext&&c.getContext("2d")){alert("No canvas support :-(")}this.id=h;this.numXFields=d;this.numYFields=g;this.flipped=e;this.isWatching=false;this.locked=false;this.animated=false;this.fenString="";this.numFields=d*g;this.highlightArray=new Array(this.numFields);for(var a=0;a<this.highlightArray.length;a++){this.highlightArray[a]=0}this.build();var b=this;this.pieceImageReady=false;this.pieceImg=new Image();var f=window.setInterval(function(){var i=$("#pieceImage").css("background-image");if(i==""){return}window.clearInterval(f);i=i.replace(/^url\(["']?(.*?)["']?\)$/,"$1");b.pieceImg.src=i;b.pieceImg.onload=function(){b.pieceImageReady=true;b.repaintFull()}},200)}Board.prototype.lock=function(){this.locked=true};Board.prototype.unlock=function(){this.locked=false};Board.prototype.isLocked=function(){return this.locked};Board.prototype.build=function(){var b=this;var a="board_"+this.id;$("#"+a).remove();var e=$("<div>").attr({id:a,"class":"board"});var c=$("<div>").attr({id:a+"-container-canvas","class":"canvas-container"});this.divCanvas=c;$("<canvas>").attr("id",a+"-canvas-board").css("z-index",0).appendTo(this.divCanvas);$("<canvas>").attr("id",a+"-canvas-highlight").css("z-index",1).appendTo(this.divCanvas);$("<canvas>").attr("id",a+"-canvas-pieces").css("z-index",2).appendTo(this.divCanvas);$("<canvas>").attr("id",a+"-canvas-dragging").css("z-index",3).appendTo(this.divCanvas);var d=this.divCanvas.find("canvas");this.canvasBoard=d.get(0);this.canvasHighlight=d.get(1);this.canvasPieces=d.get(2);this.canvasDragging=d.get(3);this.canvasFront=this.canvasDragging;this.divCanvas.css("cursor","pointer");this.addMouseEvents();this.addKeyboardEvents();topPocket=$("<div>").attr("id","top-pocket-"+this.id).addClass("pocket").addClass("top-pocket");bottomPocket=$("<div>").attr("id","bottom-pocket-"+this.id).addClass("pocket").addClass("bottom-pocket");topPlayers=$("<div>").attr("id","top-players-"+this.id).addClass("players top-players");bottomPlayers=$("<div>").attr("id","bottom-players-"+this.id).addClass("players bottom-players");$("#boards").append(e.append(c))};Board.prototype.sizeChanged=function(){var b=this.canvasBoard;var c=this.divCanvas.width();var a=this.divCanvas.height();if(Math.abs(b.width-c*globalScalingFactor)>10||Math.abs(b.height-a*globalScalingFactor)>10){var d=$('[id^="board_'+this.id+'-canvas-"]');d.css("width",c).css("height",a);d.each(function(){this.width=c*globalScalingFactor;this.height=a*globalScalingFactor});this.boardWidth=b.width-2*borderXSize;this.boardHeight=b.height-2*borderYSize;this.fieldWidth=this.boardWidth/this.numXFields;this.fieldHeight=this.boardHeight/this.numYFields;this.fieldSize=Math.floor(Math.min(this.fieldWidth,this.fieldHeight));this.fieldWidth=this.fieldSize;this.fieldHeight=this.fieldSize;this.xOffset=borderXSize+(this.boardWidth-this.fieldWidth*this.numXFields)/2;this.yOffset=borderYSize+(this.boardHeight-this.fieldHeight*this.numYFields)/2;this.boardWidth=this.fieldWidth*this.numXFields;this.boardHeight=this.fieldHeight*this.numYFields;return true}return false};Board.prototype.repaintFull=function(){this.repaintBoard();this.repaintHighlight();this.repaintPieces();this.repaintDragging()};Board.prototype.repaintBoard=function(){if(this.sizeChanged()){this.repaintFull();return}var d=this.canvasBoard;var h=d.getContext("2d");h.clearRect(0,0,d.width,d.height);h.rect(this.xOffset,this.yOffset,this.boardWidth,this.boardHeight);h.shadowOffsetX=0;h.shadowOffsetY=0;h.shadowBlur=d.width/40;h.shadowColor="gray";h.strokeStyle="black";h.fillStyle="black";h.fill();h.shadowBlur=0;var g=false;var a=0;var e=1;if(this.flipped){g=(this.numFields%2==0)?g:!g;a=this.numFields-1;e=-e}for(var f=0;f<this.numYFields;f++){for(var b=0;b<this.numXFields;b++){if(g){h.fillStyle="#1A12A6"}else{h.fillStyle="#C0BEED"}h.fillRect(this.xOffset+b*this.fieldWidth,this.yOffset+f*this.fieldHeight,this.fieldWidth,this.fieldHeight);g=!g;a+=e}g=(this.numXFields%2==0)?!g:g}};Board.prototype.repaintHighlight=function(){var d=this.canvasHighlight;var h=d.getContext("2d");h.clearRect(0,0,d.width,d.height);var g=false;var a=0;var e=1;if(this.flipped){g=(this.numFields%2==0)?g:!g;a=this.numFields-1;e=-e}for(var f=0;f<this.numYFields;f++){for(var b=0;b<this.numXFields;b++){if(this.highlightArray[a]>0){if(this.highlightArray[a]>=highlightType.SELECTION){if(g){h.fillStyle="#4A8F63"}else{h.fillStyle="#2AF775"}}else{if(this.highlightArray[a]>=highlightType.LAST_MOVE){if(g){h.fillStyle="#DBBE00"}else{h.fillStyle="#E2FA6B"}}}h.fillRect(this.xOffset+b*this.fieldWidth,this.yOffset+f*this.fieldHeight,this.fieldWidth,this.fieldHeight)}g=!g;a+=e}g=(this.numXFields%2==0)?!g:g}};Board.prototype.repaintPieces=function(){if(!this.pieceImageReady){return}if(this.fenString===""){return}var b=this.canvasPieces;var i=b.getContext("2d");i.clearRect(0,0,b.width,b.height);var j=false;var h=0;var d=1;if(this.flipped){j=(this.numFields%2==0)?j:!j;h=this.numFields-1;d=-d}var g=this.pieceImg.width;for(var k=0;k<this.numYFields;k++){for(var e=0;e<this.numXFields;e++){var a=this.fields[h];if(a!=="_"&&(this.moveFrom===undefined||this.moveFrom!==h)){var f=getPieceIndex(a);if(f===-1){continue}i.drawImage(this.pieceImg,0,f*g,g,g,this.xOffset+e*this.fieldWidth,this.yOffset+k*this.fieldHeight,this.fieldWidth,this.fieldHeight)}j=!j;h+=d}j=(this.numXFields%2==0)?!j:j}};Board.prototype.repaintDragging=function(){if(!this.pieceImageReady){return}if(this.fenString===""){return}var b=this.canvasDragging;var h=b.getContext("2d");h.clearRect(0,0,b.width,b.height);if(this.moveFrom!==undefined){var g=this.fields[this.moveFrom];if(g!==undefined&&g!=="_"){var e=getPieceIndex(g);var d=this.fieldWidth*dragZoomFactor;var f=this.fieldHeight*dragZoomFactor;var a=this.pieceImg.width;h.drawImage(this.pieceImg,0,e*a,a,a,this.mousePos[0]*globalScalingFactor-d/2,this.mousePos[1]*globalScalingFactor-f/2,d,f)}}};function getPieceIndex(b){var a=spriteOrder.indexOf(b.toLowerCase())*2;if(a>=0){if(b==b.toLowerCase()){a=a+1}}return a}Board.prototype.addMouseEvents=function(){var a=this;this.divCanvas.mousedown(function(f){var d=a.getField(f,this);if(a.moveFrom===undefined){a.moveFrom=d;a.highlight(d,highlightType.SELECTION);a.mousePos=a.getRelativePos(f);var g=a.fields[a.moveFrom];if(g!=="_"){a.divCanvas.css("cursor","none")}a.repaintHighlight();a.repaintPieces();a.repaintDragging()}else{a.moveTo=d;a.highlight(d,highlightType.SELECTION);var c=a.moveFrom;var b=a.moveTo;a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging();postMove("board_"+a.id+"_field"+c,"board_"+a.id+"_field"+b)}});this.divCanvas.mouseup(function(g){var f=a.getField(g,this);if(a.moveFrom===undefined){return}var b=(f!==a.moveFrom);if(b){a.moveTo=f;a.highlight(f,highlightType.SELECTION);var d=a.moveFrom;var c=a.moveTo;a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging();postMove("board_"+a.id+"_field"+d,"board_"+a.id+"_field"+c)}});this.divCanvas.mousemove(function(b){if(a.moveFrom!==undefined){a.mousePos=a.getRelativePos(b);a.repaintDragging()}});this.divCanvas.mouseout(function(b){a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging()});this.divCanvas.resize(function(b){a.repaintBoard();a.repaintHighlight();a.repaintPieces();a.repaintDragging()})};Board.prototype.resetMoveInput=function(){this.moveFrom=undefined;this.moveTo=undefined;this.highlightClear(highlightType.SELECTION);this.divCanvas.css("cursor","pointer")};Board.prototype.addKeyboardEvents=function(){};Board.prototype.getRelativePos=function(c){var b=jQuery(this.canvasFront);var a=c.pageX-b.offset().left;var f=c.pageY-b.offset().top;var d=[a,f];return d};Board.prototype.getField=function(d){var c=this.getRelativePos(d);var a=c[0];var h=c[1];var b=Math.floor((a*globalScalingFactor-this.xOffset)/this.fieldWidth);var f=Math.floor((h*globalScalingFactor-this.yOffset)/this.fieldHeight);var g=f*this.numXFields+b;if(this.flipped){g=this.numFields-1-g}return g};Board.prototype.getBoardControls=function(a){return'<button type="button" class="btn" onclick="_shortCastling(\''+a+'\');">O-O</button> <button type="button" class="btn" onclick="_longCastling(\''+a+'\');">O-O-O</button><br /><br /><button type="button" class="btn" id="btn_offer_draw" onclick="_offerDraw(\''+a+'\');">Offer draw</button> <button type="button" class="btn" id="btn_repetition" onclick="_repetition(\''+a+'\');">Claim Repetition</button> <button type="button" class="btn" id="btn_x_move_rule" onclick="_xMoveRule(\''+a+'\');">Claim x Move rule</button> <button type="button" class="btn" id="btn_resign" onclick="_resign(\''+a+"');\">Resign</button>"};Board.prototype.loadFen=function(b){this.fenString=b;var a=_lengthenFen(this.fenString,this.numXFields).replace(/\//g,"");this.fields=a.split("");this.repaintPieces()};Board.prototype.move=function(d,c,b,a){var d=d.replace(/.*field/,"");var c=c.replace(/.*field/,"");this.fields[c]=this.fields[d];if(b!==undefined){this.fields[c]=b}this.fields[d]="_";this.highlightClear(highlightType.LAST_MOVE);this.highlight(d,highlightType.LAST_MOVE);this.highlight(c,highlightType.LAST_MOVE);this.repaintHighlight();this.repaintPieces()};Board.prototype.highlight=function(a,b){this.highlightArray[a]|=b};Board.prototype.highlightMove=function(b,a){this.highlight(b,highlightType.LAST_MOVE);this.highlight(a,highlightType.LAST_MOVE)};Board.prototype.highlightClear=function(b){if(b===undefined){b=~0}for(var a=0;a<this.highlightArray.length;a++){this.highlightArray[a]&=~b}};function _lengthenFen(d,e){var c="__";for(var a=1;a<=e;a++){c=c+"_"}for(var a=e;a>=1;a--){var b=new RegExp(a,"g");d=d.replace(b,c.substring(0,a))}return d}function _shortenFen(d,e){var a="_";for(var b=1;b<=e;b++){a=a+"_"}for(var b=e;b>=1;b--){var c=new RegExp(a.substring(0,b),"g");d=d.replace(c,b)}return d}function playSound(a){var b=new Audio();b.src=a+".ogg";b.play()}function _debug(a,b){if(debugLevel>=b){addServerMessage(a)}}String.prototype.startsWith=function(a){return data.substring(0,input.length)===input};