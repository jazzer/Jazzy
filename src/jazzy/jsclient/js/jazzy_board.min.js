/*
Copyright (c) 2011 Johannes Mitlmeier

This file is part of Jazzy.

Jazzy is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/agpl.html>.
*/
var piece_sprite_url="img/pieces/48px/sprite48.png";var piece_order="kqrbnpcih";var piece_width=48;var server_url=self.location.protocol+"//"+self.location.host+"/";var board_cols=0;var board_rows=0;var flipped=false;var dnd_clicked=false;var dragSource=undefined;function BoardStorage(){this.boards=new Object()}BoardStorage.prototype.newBoard=function(d,b,a,c){myboard=new Board(d,b,a,c);this.boards[d]=myboard;return myboard};BoardStorage.prototype.getBoard=function(a){if(this.boards[a]!==undefined){return this.boards[a]}return undefined};function Board(d,b,a,c){this.id=d;this.width=b;this.height=a;this.flipped=c;this.isWatching=false;this.locked=false;this.myTurn=true;this.build()}Board.prototype.lock=function(){this.locked=true};Board.prototype.unlock=function(){this.locked=false};Board.prototype.build=function(){var b="board_"+this.id;var g=this;$("#"+b).parent().remove();boardDiv=$("<div>").attr("id",b).addClass("board");var a=0;var k=this.height;var h=this.width;var f=h*k;for(var j=1;j<=k;j++){for(var c=1;c<=h;c++){var i=$("<div>");fieldPos=c+j+(this.flipped?0:(h+k)%2);i.addClass("field");if(fieldPos%2==0){i.addClass("light")}else{i.addClass("dark")}if(a%h==0){i.addClass("clear_row")}if(!this.flipped){i.attr("id",b+"_field"+a)}else{i.attr("id",b+"_field"+(f-a-1))}_addEvents(i,g);boardDiv.append(i);a++}}topPocket=$("<div>").attr("id","top-pocket-"+b).addClass("pocket").addClass("top-pocket");bottomPocket=$("<div>").attr("id","bottom-pocket-"+b).addClass("pocket").addClass("bottom-pocket");outerDiv=$("<div>").append("Pocket: ").append(topPocket).append(boardDiv).append("Pocket: ").append(bottomPocket).append('<div class="roundbutton" onclick="_shortCastling(\''+b+'\');">O-O</div> <div class="roundbutton" onclick="_longCastling(\''+b+"');\">O-O-O</div><br /><br />");$("#boards").append(outerDiv);var d=$("#"+b+"_field0").width();boardDiv.css("width",d*h);var e=$("#"+b+"_field0").height();boardDiv.css("height",e*k)};Board.prototype.loadFEN=function(b){var c="board_"+this.id;$("div[id^='"+c+"_field']").children().remove();cleanFen=_lengthenFen(b,this.width).replace(/\//g,"");chars=cleanFen.split("");for(var a=0;a<chars.length;a++){$("#"+c+"_field"+a).append(this.getPieceDiv(chars[a]))}};Board.prototype.getPieceDiv=function(d){if(d==""){return""}var c=piece_order.indexOf(d.toLowerCase())*2;if(c<0){return""}if(d==d.toLowerCase()){c=c+1}var a=$("<div>");var b=server_url=="file:///"?piece_sprite_url:server_url+piece_sprite_url;a.css({"background-image":"url("+b+")","background-color":"transparent","background-repeat":"no-repeat",height:piece_width,width:piece_width,"background-position":"-0px -"+(c*piece_width)+"px"});return a};Board.prototype.move=function(d,c,b,a){if(d==-1){return}if(a===undefined){a=false}fromField=$("#"+d);toField=$("#"+c);isCapture=(toField.children().length>0);isPiece=(fromField.children().length>0);if(!isPiece){return}toField.children().css({"z-index":"2"}).fadeOut(400,function(){$(this).remove()});outerThis=this;fromField.children().css({position:"relative","z-index":1,left:0,top:0}).animate({left:toField.offset().left-fromField.offset().left,top:toField.offset().top-fromField.offset().top},400,"swing",function(){if(b!=undefined){$(this).fadeOut(400).parent().append(outerThis.getPieceDiv(b)).fadeIn(400)}fromField.children().css({top:0,left:0}).detach().prependTo(toField)});if(!a){this.highlight_move(d,c);highlight(c,"move_to");if(isCapture){playSound("media/capture")}else{playSound("media/move")}}dragSource=undefined;dnd_clicked=false};Board.prototype.highlight_move=function(b,a){this.highlight_clear();highlight(b,"move_from");highlight(a,"move_to")};Board.prototype.highlight_clear=function(){var a="board_"+this.id;$("#"+a).find('div[id*="field"]').each(function(){$(this)[0].className=$(this)[0].className.replace(/highlight_[^ ]*/,"")})};function _dnd_down(b,a){if(!a.locked&&a.myTurn&&b.children().length>0&&!dnd_clicked){dragSource=b.attr("id");b.addClass("highlight_input_move_from")}}function _dnd_up(a){if(dragSource==undefined||dnd_clicked){return}dropTarget=a.attr("id");if(dropTarget!==undefined&&dragSource!=dropTarget){postMove(dragSource,dropTarget)}$("#"+dragSource).removeClass("highlight_input_move_from");dragSource=undefined}function _dnd_click(b,a){if(dragSource==undefined){_dnd_down(b,a);dnd_clicked=true}else{dnd_clicked=false;_dnd_up(b)}}function _lengthenFen(d,e){var c="__";for(var a=2;a<=e;a++){c=c+"_"}for(var a=e;a>=2;a--){var b=new RegExp(a,"g");d=d.replace(b,c.substring(0,a))}return d}function _shortenFen(d,e){var a="_";for(var b=2;b<=e;b++){a=a+"_"}for(var b=e;b>=2;b--){var c=new RegExp(a.substring(0,b),"g");d=d.replace(c,b)}return d}function playSound(a){var b=new Audio();b.src=a+".ogg";b.play()}function highlight(a,b){$("#"+a).addClass("highlight_"+b)}function _addEvents(a,b){if(!b.isWatching){a.mousedown(function(){_dnd_down($(this),b)});a.mouseup(function(){_dnd_up($(this))});a.click(function(){_dnd_click($(this),b)})}}function _debug(a,b){if(debugLevel>=b){addServerMessage(a)}}String.prototype.startsWith=function(a){return data.substring(0,input.length)===input};$(document).ready(function(){$(document).bind("dragstart",function(a){if(a.target.nodeName.toLowerCase()=="div"){return false}})});