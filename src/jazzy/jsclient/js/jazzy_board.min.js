/*
Copyright (c) 2011 Johannes Mitlmeier

This file is part of Jazzy.

Jazzy is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/agpl.html>.
*/
var piece_sprite_url="img/pieces/48px/sprite48.png";var piece_order="kqrbnpcih";var piece_width=48;var server_url=self.location.protocol+"//"+self.location.host+"/";var board_cols=0;var board_rows=0;var flipped=false;var dnd_clicked=false;var dragSource=undefined;var ui_setting_animate_move=true;function BoardStorage(){this.boards=new Object()}BoardStorage.prototype.newBoard=function(d,b,a,c){myboard=new Board(d,b,a,c);this.boards[d]=myboard;return myboard};BoardStorage.prototype.getBoard=function(a){if(this.boards[a]!==undefined){return this.boards[a]}return undefined};function Board(d,b,a,c){this.id=d;this.width=b;this.height=a;this.flipped=c;this.isWatching=false;this.locked=false;this.animated=false;this.build()}Board.prototype.lock=function(){this.locked=true};Board.prototype.unlock=function(){this.locked=false};Board.prototype.isLocked=function(){return this.locked};Board.prototype.build=function(){var b="board_"+this.id;var g=this;$("#"+b).parent().remove();boardDiv=$("<div>").attr("id",b).addClass("board");var a=0;var k=this.height;var h=this.width;var f=h*k;for(var j=1;j<=k;j++){for(var c=1;c<=h;c++){var i=$("<div>");fieldPos=c+j+(this.flipped?0:(h+k)%2);i.addClass("field");if(fieldPos%2==0){i.addClass("light")}else{i.addClass("dark")}if(a%h==0){i.addClass("clear_row")}if(!this.flipped){i.attr("id",b+"_field"+a)}else{i.attr("id",b+"_field"+(f-a-1))}_addEvents(i,g);boardDiv.append(i);a++}}topPocket=$("<div>").attr("id","top-pocket-"+b).addClass("pocket").addClass("top-pocket");bottomPocket=$("<div>").attr("id","bottom-pocket-"+b).addClass("pocket").addClass("bottom-pocket");topPlayers=$("<div>").attr("id","top-players-"+b).addClass("players top-players");bottomPlayers=$("<div>").attr("id","bottom-players-"+b).addClass("players bottom-players");outerDiv=$("<div>").attr("id",b+"-frame").append(topPocket).append(topPlayers).append(boardDiv).append(bottomPlayers).append(bottomPocket).append($("<div>").attr("id",b+"-controls").append(getBoardControls(b)));$("#boards").append(outerDiv);var d=$("#"+b+"_field0").width();boardDiv.css("width",d*h);var e=$("#"+b+"_field0").height();boardDiv.css("height",e*k)};function getBoardControls(a){return'<button type="button" class="btn" onclick="_shortCastling(\''+a+'\');">O-O</button> <button type="button" class="btn" onclick="_longCastling(\''+a+'\');">O-O-O</button><br /><br /><button type="button" class="btn" id="btn_offer_draw" onclick="_offerDraw(\''+a+'\');">Offer draw</button> <button type="button" class="btn" id="btn_repetition" onclick="_repetition(\''+a+'\');">Claim Repetition</button> <button type="button" class="btn" id="btn_x_move_rule" onclick="_xMoveRule(\''+a+'\');">Claim x Move rule</button> <button type="button" class="btn" id="btn_resign" onclick="_resign(\''+a+"');\">Resign</button>"}Board.prototype.loadFEN=function(b){var c="board_"+this.id;$("div[id^='"+c+"_field']").children().remove();cleanFen=_lengthenFen(b,this.width).replace(/\//g,"");chars=cleanFen.split("");for(var a=0;a<chars.length;a++){$("#"+c+"_field"+a).append(this.getPieceDiv(chars[a]))}};Board.prototype.getPieceDiv=function(d){if(d==""){return""}var c=piece_order.indexOf(d.toLowerCase())*2;if(c<0){return""}if(d==d.toLowerCase()){c=c+1}var a=$("<div>");var b=server_url=="file:///"?piece_sprite_url:server_url+piece_sprite_url;a.css({"background-image":"url("+b+")","background-color":"transparent","background-repeat":"no-repeat",height:piece_width,width:piece_width,"background-position":"-0px -"+(c*piece_width)+"px"});return a};Board.prototype.move=function(h,g,f,b){if(h==-1){return}if(b===undefined){var b=false}this.animated=true;var e=$("#"+h);var a=$("#"+g);var d=(e.children().length>0);if(!d){this.animated=false;return}e.children().stop(true,true);var c=(a.children().length>0);if(ui_setting_animate_move){if(c){a.children().css({"z-index":"2"}).fadeOut(400,function(){$(this).remove()})}outerThis=this;e.children().css({position:"relative","z-index":1,left:0,top:0}).animate({left:a.offset().left-e.offset().left,top:a.offset().top-e.offset().top},400,"swing",function(){if(f!=undefined){$(this).fadeOut(400).parent().append(outerThis.getPieceDiv(f)).fadeIn(400)}e.children().css({top:0,left:0}).detach().prependTo(a);outerThis.animated=false})}else{a.children().remove();e.children().detach().appendTo(a);this.animated=false}if(!b){this.highlight_move(h,g);if(c){playSound("media/capture")}else{playSound("media/move")}}_dnd_remove()};Board.prototype.highlight_move=function(b,a){this.highlight_clear();highlight(b,"move_from");highlight(a,"move_to")};Board.prototype.highlight_clear=function(){var a="board_"+this.id;$("#"+a).find('div[id*="field"]').each(function(){$(this)[0].className=$(this)[0].className.replace(/highlight_[^ ]*/,"")})};function _dnd_down(b,a){if(dragSource===b.attr("id")){dragSource=undefined}if(!a.isLocked()&&myTurn[a.id]&&b.children().length>0&&!dnd_clicked){dragSource=b.attr("id");b.addClass("highlight_input_move_from")}}function _dnd_up(b,a){if(a.isLocked()||dragSource===undefined){_dnd_remove();return}dropTarget=b.attr("id");if(dropTarget!==undefined){if(dragSource===dropTarget){dnd_clicked=true}else{postMove(dragSource,dropTarget);_dnd_remove();dnd_clicked=false}}}function _dnd_remove(){dragSource=undefined;$('[class*="highlight_input_move_from"]').removeClass("highlight_input_move_from");dnd_clicked=false}function _lengthenFen(d,e){var c="__";for(var a=2;a<=e;a++){c=c+"_"}for(var a=e;a>=2;a--){var b=new RegExp(a,"g");d=d.replace(b,c.substring(0,a))}return d}function _shortenFen(d,e){var a="_";for(var b=2;b<=e;b++){a=a+"_"}for(var b=e;b>=2;b--){var c=new RegExp(a.substring(0,b),"g");d=d.replace(c,b)}return d}function playSound(a){var b=new Audio();b.src=a+".ogg";b.play()}function highlight(a,b){$("#"+a).addClass("highlight_"+b)}function _addEvents(a,b){if(!b.isWatching){a.mousedown(function(){_dnd_down($(this),b)});a.mouseup(function(){_dnd_up($(this),b)})}}function _debug(a,b){if(debugLevel>=b){addServerMessage(a)}}String.prototype.startsWith=function(a){return data.substring(0,input.length)===input};$(document).ready(function(){$(document).bind("dragstart",function(a){if(a.target.nodeName.toLowerCase()=="div"){return false}})});