/*
Copyright (c) 2011-2012 Johannes Mitlmeier

This file is part of Jazzy.

Jazzy is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/agpl.html>.
*/
var borderXSize=50;var borderYSize=50;var fontWidth=100;var globalScalingFactor=2;var dragZoomFactor=1.5;var spriteOrder="kqrbnpcih";var highlightType={LAST_MOVE:1,SELECTION:2,PREMOVE:4};function BoardStorage(){this.boards=[]}BoardStorage.prototype.newBoard=function(e,b,d,c){var a=new Board(e,b,d,c);this.boards[e]=a;return a};BoardStorage.prototype.getBoard=function(a){if(this.boards[a]!==undefined){return this.boards[a]}return undefined};function Board(f,c,e,d){var b=document.createElement("canvas");if(!b.getContext&&b.getContext("2d")){alert("No canvas support :-(")}this.id=f;this.numXFields=c;this.numYFields=e;this.flipped=d;this.isWatching=false;this.locked=false;this.animated=false;this.fenString="";this.numFields=c*e;this.pieceImageReady=false;this.waiting=false;this.highlightArray=new Array(this.numFields);for(var a=0;a<this.highlightArray.length;a++){this.highlightArray[a]=0}this.build();this.pullStyles()}Board.prototype.lock=function(){this.locked=true};Board.prototype.unlock=function(){this.locked=false};Board.prototype.isLocked=function(){return this.locked};Board.prototype.pullStyles=function(){var a=this;a.pieceImageReady=false;a.pieceImg=new Image();var b=window.setInterval(function(){var c=($("#pieceImage-board_"+a.id).length>0?$("#pieceImage-board_"+a.id):$("#pieceImage")).css("background-image");if(c===""){return}window.clearInterval(b);c=c.replace(/^url\(["']?(.*?)["']?\)$/,"$1");a.pieceImg.src="";a.pieceImg.src=c;a.backgroundStyle=($("#backgroundColors-board_"+a.id).length>0?$("#backgroundColors-board_"+a.id):$("#backgroundColors"));a.highlightStyles=[];a.highlightStyles[highlightType.LAST_MOVE]=($("#highlightColors-1-board_"+a.id).length>0?$("#highlightColors-1-board_"+a.id):$("#highlightColors-1"));a.highlightStyles[highlightType.SELECTION]=($("#highlightColors-2-board_"+a.id).length>0?$("#highlightColors-2-board_"+a.id):$("#highlightColors-2"));a.highlightStyles[highlightType.PREMOVE]=($("#highlightColors-3-board_"+a.id).length>0?$("#highlightColors-3-board_"+a.id):$("#highlightColors-3"));a.pieceImg.onload=function(){a.pieceImageReady=true;a.waiting=false;a.repaintFull()}},200)};Board.prototype.build=function(){var c=this;var b="board_"+this.id;$("#"+b).remove();var e=$("<div>").attr({id:b,"class":"board"});var d=$("<div>").attr({id:b+"-container-canvas","class":"canvas-container"});this.divCanvas=d;this.canvasBoard=$("<canvas>").attr("id",b+"-canvas-board").css("z-index",0).appendTo(this.divCanvas).get(0);this.canvasHighlight=$("<canvas>").attr("id",b+"-canvas-highlight").css("z-index",1).appendTo(this.divCanvas).get(0);this.canvasPieces=$("<canvas>").attr("id",b+"-canvas-pieces").css("z-index",2).appendTo(this.divCanvas).get(0);this.canvasDragging=$("<canvas>").attr("id",b+"-canvas-dragging").css("z-index",3).appendTo(this.divCanvas).get(0);this.canvasFront=this.canvasDragging;this.divCanvas.css("cursor","pointer");this.addMouseEvents();this.addKeyboardEvents();e.append(d);var a=_getTemplate("#board_boardId-top-data");a=_replaceInTemplate(a,"boardId",this.id);console.debug(a);e.prepend(a);a=_getTemplate("#board_boardId-bottom-data");a=_replaceInTemplate(a,"boardId",this.id);e.append(a);a=_getTemplate("#board_boardId-controls");a=_replaceInTemplate(a,"boardId",this.id);e.append(a);$("#boards").append(e)};Board.prototype.sizeChanged=function(){var b=this.canvasBoard;var c=this.divCanvas.width();var a=this.divCanvas.height();if(Math.abs(b.width-c*globalScalingFactor)>10||Math.abs(b.height-a*globalScalingFactor)>10){var d=$('[id^="board_'+this.id+'-canvas-"]');d.css("width",c).css("height",a);d.each(function(){this.width=c*globalScalingFactor;this.height=a*globalScalingFactor});this.boardWidth=b.width-2*borderXSize;this.boardHeight=b.height-2*borderYSize;this.fieldWidth=this.boardWidth/this.numXFields;this.fieldHeight=this.boardHeight/this.numYFields;this.fieldSize=Math.floor(Math.min(this.fieldWidth,this.fieldHeight));this.fieldWidth=this.fieldSize;this.fieldHeight=this.fieldSize;this.xOffset=borderXSize+(this.boardWidth-this.fieldWidth*this.numXFields)/2;this.yOffset=borderYSize+(this.boardHeight-this.fieldHeight*this.numYFields)/2;this.boardWidth=this.fieldWidth*this.numXFields;this.boardHeight=this.fieldHeight*this.numYFields;return true}return false};Board.prototype.repaintFull=function(){var a=this;if(!a.pieceImageReady){if(!a.waiting){a.waiting=true;window.setTimeout(function(){a.repaintFull()},200)}return}a.waiting=false;a.repaintBoard();a.repaintHighlight();a.repaintPieces();a.repaintDragging()};Board.prototype.repaintBoard=function(){if(this.sizeChanged()){this.repaintFull();return}var d=this.canvasBoard;var h=d.getContext("2d");h.clearRect(0,0,d.width,d.height);h.rect(this.xOffset,this.yOffset,this.boardWidth,this.boardHeight);h.shadowOffsetX=0;h.shadowOffsetY=0;h.shadowBlur=d.width/40;h.shadowColor="gray";h.strokeStyle="black";h.fillStyle="black";h.fill();h.shadowBlur=0;var g=false;var a=0;var e=1;if(this.flipped){g=(this.numFields%2===0)?g:!g;a=this.numFields-1;e=-e}for(var f=0;f<this.numYFields;f++){for(var b=0;b<this.numXFields;b++){if(g){h.fillStyle=this.backgroundStyle.css("background-color")}else{h.fillStyle=this.backgroundStyle.css("color")}h.fillRect(this.xOffset+b*this.fieldWidth,this.yOffset+f*this.fieldHeight,this.fieldWidth,this.fieldHeight);g=!g;a+=e}g=(this.numXFields%2===0)?!g:g}};Board.prototype.repaintHighlight=function(){var d=this.canvasHighlight;var h=d.getContext("2d");h.clearRect(0,0,d.width,d.height);var g=false;var a=0;var e=1;if(this.flipped){g=(this.numFields%2===0)?g:!g;a=this.numFields-1;e=-e}for(var f=0;f<this.numYFields;f++){for(var b=0;b<this.numXFields;b++){if(this.highlightArray[a]>0){if(this.highlightArray[a]>=highlightType.PREMOVE){if(g){h.fillStyle=this.highlightStyles[highlightType.PREMOVE].css("background-color")}else{h.fillStyle=this.highlightStyles[highlightType.PREMOVE].css("color")}}else{if(this.highlightArray[a]>=highlightType.SELECTION){if(g){h.fillStyle=this.highlightStyles[highlightType.SELECTION].css("background-color")}else{h.fillStyle=this.highlightStyles[highlightType.SELECTION].css("color")}}else{if(this.highlightArray[a]>=highlightType.LAST_MOVE){if(g){h.fillStyle=this.highlightStyles[highlightType.LAST_MOVE].css("background-color")}else{h.fillStyle=this.highlightStyles[highlightType.LAST_MOVE].css("color")}}}}h.fillRect(this.xOffset+b*this.fieldWidth,this.yOffset+f*this.fieldHeight,this.fieldWidth,this.fieldHeight)}g=!g;a+=e}g=(this.numXFields%2===0)?!g:g}};Board.prototype.repaintPieces=function(){if(!this.pieceImageReady){return}if(this.fenString===""){return}var b=this.canvasPieces;var i=b.getContext("2d");i.clearRect(0,0,b.width,b.height);var h=0;var d=1;if(this.flipped){h=this.numFields-1;d=-d}var g=this.pieceImg.width;for(var j=0;j<this.numYFields;j++){for(var e=0;e<this.numXFields;e++){var a=this.fields[h];if(a!=="_"&&(this.moveFrom===undefined||this.moveFrom!==h)){var f=getPieceIndex(a);if(f===-1){continue}i.drawImage(this.pieceImg,0,f*g,g,g,this.xOffset+e*this.fieldWidth,this.yOffset+j*this.fieldHeight,this.fieldWidth,this.fieldHeight)}h+=d}}};Board.prototype.repaintDragging=function(){if(!this.pieceImageReady){return}if(this.fenString===""){return}var b=this.canvasDragging;var h=b.getContext("2d");h.clearRect(0,0,b.width,b.height);if(this.moveFrom!==undefined){var g=this.fields[this.moveFrom];if(g!==undefined&&g!=="_"){var e=getPieceIndex(g);var d=this.fieldWidth*dragZoomFactor;var f=this.fieldHeight*dragZoomFactor;var a=this.pieceImg.width;h.drawImage(this.pieceImg,0,e*a,a,a,this.mousePos[0]*globalScalingFactor-d/2,this.mousePos[1]*globalScalingFactor-f/2,d,f)}}};function getPieceIndex(b){var a=spriteOrder.indexOf(b.toLowerCase())*2;if(a>=0){if(b==b.toLowerCase()){a=a+1}}return a}Board.prototype.addMouseEvents=function(){var a=this;this.divCanvas.mousedown(function(g){a.resetPremoveInput();if(g.shiftKey){a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging()}var f=a.getField(g,this);if(f==-1){return}if(a.moveFrom===undefined){a.moveFrom=f;a.highlight(f,highlightType.SELECTION);a.mousePos=a.getRelativePos(g);var h=a.fields[a.moveFrom];if(h!=="_"){a.divCanvas.css("cursor","none")}a.repaintHighlight();a.repaintPieces();a.repaintDragging()}else{a.moveTo=f;a.highlight(f,highlightType.SELECTION);var d=a.moveFrom;var c=a.moveTo;a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging();var b=new Move(a.id,d,c,undefined,g.ctrlKey);a.handleMoveInput(b)}});this.divCanvas.mouseup(function(h){if(h.shiftKey){a.resetPremoveInput();a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging()}var g=a.getField(h,this);if(g==-1){return}if(a.moveFrom===undefined){return}var b=(g!==a.moveFrom);if(b){a.moveTo=g;a.highlight(g,highlightType.SELECTION);var f=a.moveFrom;var d=a.moveTo;a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging();var c=new Move(a.id,f,d,undefined,h.ctrlKey);a.handleMoveInput(c)}});this.divCanvas.mousemove(function(b){if(a.moveFrom!==undefined){a.mousePos=a.getRelativePos(b);a.repaintDragging()}});this.divCanvas.mouseout(function(b){a.resetMoveInput();a.repaintHighlight();a.repaintPieces();a.repaintDragging()});this.divCanvas.resize(function(b){a.repaintBoard();a.repaintHighlight();a.repaintPieces();a.repaintDragging()})};Board.prototype.handleMoveInput=function(a){var b=this;if($("#board_"+b.id).find(".player-me.player-curr").length>0){a.send()}else{b.premove=a;b.highlight(a.from,highlightType.PREMOVE);b.highlight(a.to,highlightType.PREMOVE);b.repaintHighlight()}};Board.prototype.resetPremoveInput=function(){this.premove=undefined;this.highlightClear(highlightType.PREMOVE)};Board.prototype.resetMoveInput=function(){this.moveFrom=undefined;this.moveTo=undefined;this.highlightClear(highlightType.SELECTION);this.divCanvas.css("cursor","pointer")};Board.prototype.addKeyboardEvents=function(){};Board.prototype.getRelativePos=function(c){var b=jQuery(this.canvasFront);var a=c.pageX-b.offset().left;var f=c.pageY-b.offset().top;var d=[a,f];return d};Board.prototype.getField=function(d){var c=this.getRelativePos(d);var a=c[0];var h=c[1];var b=Math.floor((a*globalScalingFactor-this.xOffset)/this.fieldWidth);var f=Math.floor((h*globalScalingFactor-this.yOffset)/this.fieldHeight);if(b<0||b>=this.numXFields||f<0||f>=this.numYFields){return -1}var g=f*this.numXFields+b;if(this.flipped){g=this.numFields-1-g}return g};Board.prototype.loadFen=function(b){this.fenString=b;var a=_lengthenFen(this.fenString,this.numXFields).replace(/\//g,"");this.fields=a.split("");this.repaintPieces()};Board.prototype.move=function(e,d,c,a){e=e.replace(/.*field/,"");d=d.replace(/.*field/,"");var b=(this.fields[d]!=="_");this.fields[d]=this.fields[e];if(c!==undefined){this.fields[d]=c}this.fields[e]="_";if(b){playSound("media/capture")}else{playSound("media/move")}this.highlightClear(highlightType.LAST_MOVE);this.highlight(e,highlightType.LAST_MOVE);this.highlight(d,highlightType.LAST_MOVE);if(this.premove!==undefined){this.premove.send();this.resetPremoveInput()}this.repaintHighlight();this.repaintPieces()};Board.prototype.getPieceDiv=function(d){var c=getPieceIndex(d);if(c==-1){return""}var a=$("<div>");var b=($("#pieceImage-board_"+board.id).length>0?$("#pieceImage-board_"+board.id):$("#pieceImage")).css("background-image");a.css({"background-image":b,"background-color":"transparent","background-repeat":"no-repeat",height:this.pieceImg.width,width:this.pieceImg.width,"background-position":"-0px -"+(c*this.pieceImg.width)+"px"});return a};Board.prototype.highlight=function(a,b){this.highlightArray[a]|=b};Board.prototype.highlightMove=function(b,a){this.highlight(b,highlightType.LAST_MOVE);this.highlight(a,highlightType.LAST_MOVE)};Board.prototype.highlightClear=function(b){if(b===undefined){b=~0}for(var a=0;a<this.highlightArray.length;a++){this.highlightArray[a]&=~b}};function _lengthenFen(d,e){var c="__";for(var a=1;a<=e;a++){c=c+"_"}for(a=e;a>=1;a--){var b=new RegExp(a,"g");d=d.replace(b,c.substring(0,a))}return d}function _shortenFen(d,e){var a="_";for(var b=1;b<=e;b++){a=a+"_"}for(b=e;b>=1;b--){var c=new RegExp(a.substring(0,b),"g");d=d.replace(c,b)}return d}function playSound(a){var b=new Audio();b.src=a+".ogg";b.play()}function _debug(a,b){if(debugLevel>=b){addServerMessage(a)}}String.prototype.startsWith=function(a){return data.substring(0,input.length)===input};