/*
Copyright (c) 2011 Johannes Mitlmeier

This file is part of Jazzy.

Jazzy is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/agpl.html>.
*/
var server_url=self.location.protocol+"//"+self.location.host+"/";var base_interval=1000;var max_interval=15000;var interval_factor=1.4;var myTurn=true;var noCalls=false;var styleNames="gray,light-wood,dark-wood,mono";if(typeof BoardStorage=="function"){var boardStorage=new BoardStorage()}var debugLevel=1;var refreshInterval=2;var sinceLastRefresh=0;var gameId=undefined;var mqId=undefined;var lastParsedMsg=undefined;var activeJSONCall=false;var currPlayer=undefined;var availible_games=undefined;var currSelectedGame=undefined;var unsuccessfulServerCallCounter=-1;var styleNameArray=styleNames.split(",");var QUALITY_BUFFER_SIZE=5;var qualityBuffer=new Array(QUALITY_BUFFER_SIZE);var qualitySum=QUALITY_BUFFER_SIZE;for(var i=0;i<QUALITY_BUFFER_SIZE;i++){qualityBuffer[i]=1}var qualityBufferIndex=0;$.ajaxSetup({error:connFailed});function _debug(a,b){if(debugLevel>=b){addServerMessage(a)}}function _playInit(){$(document).ready(function(){mqId=window.location.href.match(/[\dA-Fa-f]+$/);$('[name="debugLevel"]').attr("value",debugLevel);serverCall("getsit/"+mqId,function(b){parseMQ(b)},false,true);addServerMessage("Finished setting up game.");setTimeout("refresh()",base_interval);$("#btnDisconnect").toggle(function(){$(this).html("Connect");noCalls=true;showConnectionState(0)},function(){$(this).html("Disconnect");noCalls=false;showConnectionState(100);refresh()});var a=$('[name^="style-chooser-"]');for(styleIndex in styleNameArray){a.append($("<option>").text(styleNameArray[styleIndex]))}$('select[name="style-chooser-main"]').change(function(){_changeStyle("main")});$('select[name="style-chooser-board"]').change(function(){_changeStyle("board")})})}function _dataInit(){$(document).ready(function(){$('div[class^="data_content"]').children().remove().end().hide();$('div[id^="data__"]').toggle(function(){id=$(this).attr("id").replace(/^data__/,"");long_data=getLongData(id);$(this).find('[class^="inline_content"]').html("");$(this).find('[class^="data_content"]').html(long_data).toggleClass("data_content_empty").toggleClass("data_content").slideDown(500)},function(){id=$(this).attr("id").replace(/^data__/,"");short_data=getShortData(id);$(this).find('[class^="inline_content"]').html(short_data);$(this).find('[class^="data_content"]').slideUp(500,function(){$(this).toggleClass("data_content_empty").toggleClass("data_content")})}).click().click()})}function _changeStyle(b,c){var d;if(b=="main"){d=$('[name^="style-chooser-main"]')}else{d=$('[name^="style-chooser-board"]')}if(c!=undefined){a=d.val(c)}c=d.val();var a="css/"+d.val()+"-"+b+".css";if($('link[href="css/'+a+'"]').size()>0){return}for(styleIndex in styleNameArray){$('link[href="css/'+styleNameArray[styleIndex]+"-"+b+'.css"]').remove()}$("head").append($("<link>").attr({type:"text/css",rel:"stylesheet",href:a}));if(b=="main"){_changeStyle("board",c)}}function getLongData(a){return"THESE ARE THE LONG DATA FOR "+a}function getShortData(a){return"short data for "+a}function watchGame(){joinOrWatchGame("watch")}function joinGame(){joinOrWatchGame("join")}function joinOrWatchGame(a){$(function(){gameId=window.location.href.match(/[\dA-Fa-f]+$/);serverCall(a+"/"+gameId,function(b){mqId=b.mqId;if(mqId!=undefined){location.href=server_url+"play.html?"+mqId}else{$("#messages").append($("<span>").addClass("message").html(b.msg))}},false,true)})}function load_availible_games(){$(function(){serverCall("getgames",function(a){availible_games=a;buildCategories()},false,true)})}function connFailed(){connChange(0)}function connSucceeded(){connChange(1)}function connChange(c){var b=qualityBuffer[qualityBufferIndex];qualitySum=qualitySum-b+c;qualityBuffer[qualityBufferIndex]=c;qualityBufferIndex=(qualityBufferIndex+1)%QUALITY_BUFFER_SIZE;var a=qualitySum/QUALITY_BUFFER_SIZE*100;showConnectionState(a)}function showConnectionState(b){var c="Connected";var a="conn_good";if(b<=80){c="Unknown";a="conn_unknown"}if(b<=20){c="Not Connected";a="conn_bad"}$("#conn_status").html(c).removeClass("conn_bad conn_unknown conn_good").addClass(a)}function buildCategories(){if(availible_games==undefined){return}target=$("#gameSelection_step1");target.empty();categories=new Object();for(gameId in availible_games){game=availible_games[gameId];categories[game.cat]=1}for(cat in categories){entry=$("<div>").addClass("entry").html(cat);entry.click(function(){showGames($(this).html())});target.append(entry)}}function showGames(a){target=$("#gameSelection_step2");target.empty();for(gameId in availible_games){game=availible_games[gameId];if(game.cat==a){entry=$("<div>").addClass("entry").html(game.title);entry.click(function(){showDetails($(this).html())});target.append(entry)}}}function showDetails(a){target=$("#gameSelection_step3");target.empty();for(gameId in availible_games){loopGame=availible_games[gameId];if(a==loopGame.title){target.html(loopGame.title+"<br/>"+loopGame.desc+"<br/>"+loopGame.details+'<br/><a href="'+loopGame.link+'">More...</a>');break}}currSelectedGame=a}function buildClassicBoard(e,j,g){if(e==board_cols&&j==board_rows&&g==flipped){return}$("#board").empty();var a=0;board_cols=e;board_rows=j;flipped=g;fields=board_cols*board_rows;for(var h=1;h<=j;h++){for(var b=1;b<=e;b++){var f=$("<div>");fieldPos=b+h+(flipped?0:(e+j)%2);f.addClass("field");if(fieldPos%2==0){f.addClass("light")}else{f.addClass("dark")}if(a%e==0){f.addClass("clear_row")}if(!flipped){f.attr("id","field"+a)}else{f.attr("id","field"+(fields-a-1))}if(!isWatching){f.mousedown(function(){_dnd_down($(this))});f.mouseup(function(){_dnd_up($(this))});f.click(function(){_dnd_click($(this))})}$("#board").append(f);a++}}var c=$("#field0").width();$("#board").css("width",c*e);var d=$("#field0").height();$("#board").css("height",d*j);_debug("Created board of size "+board_cols+"x"+board_rows,3)}function postMove(d,c,b){var a="post/"+mqId+"/move/"+shortenFieldString(d)+"/"+shortenFieldString(c);if(b!=undefined){a+="/"+b}serverCall(a,function(e){parseMQ(e)},true,true)}function _shortCastling(a){postMove(a+"_SHORTCASTLING","")}function _longCastling(a){postMove(a+"_LONGCASTLING","")}function addServerMessage(b){var a=$("<span>").addClass("message").html(_getTime(false)+b+"<br/>");$("#messages").append(a).scrollTop(100000000)}function addChatMessage(b,c){var a=$("<span>");if(b=="_"){a.addClass("chat_self");a.html(_getTime()+c+"<br/>")}else{a.addClass("chat_other");a.html(_getTime()+'<span class="chat_username">'+b+"</span>"+c+"<br/>")}$("#chat_history").append(a).scrollTop(100000000)}function sendChat(){var a=$('input[name="chatmsg"]').attr("value");if(a===""){return}$('input[name="chatmsg"]').attr("value","");addChatMessage("_",a);serverCall("post/"+mqId+"/chat/"+encodeURIComponent(a),function(b){parseMQ(b)},true,true)}function _getTime(c){if(arguments.length==0){c=true}var a='<span class="time">';var b=new Date();if(b.getHours()<10){a=a+"0"}a=a+b.getHours()+":";if(b.getMinutes()<10){a=a+"0"}a=a+b.getMinutes();if(!c){a=a+":";if(b.getSeconds()<10){a=a+"0"}a=a+b.getSeconds()}return a+"</span>"}function refresh(){if(!noCalls){sinceLastRefresh++;if(refreshInterval>sinceLastRefresh){}_debug("Refreshed state.",5);getMQ()}}function createGame(){if(currSelectedGame==undefined){return}$(function(){$("#created_links").html();type=currSelectedGame;createNewGameIds(type);var a=server_url+"play.html?"+mqId;var c=server_url+"join.html?"+gameId;var b=server_url+"watch.html?"+gameId;$("#created_links").html('<b><h3>Your link:</h3> <a href="'+a+'">'+a+'</a></b><h3>Link for other players:</h3><a href="'+c+'">'+c+'</a><h3>Watch Game:</h3><a href="'+b+'">'+b+"</a>")})}function createNewGameIds(a){$.ajax({url:server_url+"new/"+a+"/"+new Date().getTime(),async:false,dataType:"json",success:function(b){mqId=b.mqId;gameId=b.gameId}})}function serverCall(b,e,d,c){var a=b+ackString();if(c){a=a+"/"+new Date().getTime()}$.ajax({url:server_url+a,async:d,dataType:"json",success:function(f){e(f);connSucceeded()}})}function _repetition(){serverCall("claim/"+mqId+"/repetition",function(a){parseMQ(a)},true,true)}function _xMoveRule(){serverCall("claim/"+mqId+"/xmoverule",function(a){parseMQ(a)},true,true)}function ackString(){if(lastParsedMsg==undefined){return""}var a="/ack/"+lastParsedMsg;lastParsedMsg=undefined;return a}function getMQ(){if(activeJSONCall||mqId==undefined){_debug("getMQ aborted ("+activeJSONCall+")",5);return}activeJSONCall=true;var a=server_url+"getmq/"+mqId+ackString()+"/"+new Date().getTime();_debug("now checking url "+a,5);$.getJSON(a,function(b){parseMQ(b);activeJSONCall=false;setTimeout("refresh()",refreshInterval)}).error(function(d,b,c){activeJSONCall=false;recalcInterval(false);setTimeout(function(){refresh()},refreshInterval);_debug("json error: "+d.status+" "+b+" "+c,5)})}function recalcInterval(a){if(a){refreshInterval=base_interval}else{refreshInterval=Math.min(max_interval,refreshInterval*interval_factor)}}function parseCurrPlayer(a){if(a==undefined){return}currPlayer=a;if(!myTurn&&currPlayer==mqId.toString().substring(0,10)){document.title="[*] "+document.title;myTurn=true}else{if(myTurn&&currPlayer!=mqId.toString().substring(0,10)){document.title=document.title.replace(/\[.\] /,"");myTurn=false}}}function _changeDebugLevel(){$(function(){debugLevel=$('[name="debugLevel"]').attr("value")})}function makeWatching(){isWatching=true;$("div[id^='field']").unbind()}function shortenFieldString(a){if(a===undefined){return undefined}return a.replace(/^board_/,"").replace(/_field/,"_")}function lengthenFieldString(a){if(a===undefined){return undefined}return a.replace(/_/,"_field").replace(/^/,"board_")}function _resign(){var a=confirm("Do you really want to resign?");if(a){serverCall("end/"+mqId+"/resign",undefined,true,false)}}function _offerDraw(){if(myTurn){alert("You can only offer draw on your opponent's turn.");return}var a=confirm("Do you really want to offer a draw?");if(a){serverCall("end/"+mqId+"/draw-offer",undefined,true,false)}}function _fillPocket(a,f,e){var h=(a=="top"&&!e.flipped)||(a=="bottom"&&e.flipped)?"1":"0";var d=$("#"+a+"-pocket-board_"+e.id).empty();for(var c=0;c<f.length;c++){var b=e.getPieceDiv(f.charAt(c));var g=$("<div>").addClass("field").attr("id","board_"+e.id+"_fieldp"+h+c).append(b);_addEvents(g,e);d.append(g)}}function parseMQ(d){recalcInterval(d.length>0);if(d.length>0){_debug("Received message queue: "+JSON.stringify(d,null,"\t"),2)}for(var f=0;f<d.length;f++){if(lastParsedMsg==d[f]["mid"]){return}}for(var f=0;f<d.length;f++){mtype=d[f]["mtype"];switch(mtype){case"move":silent=d[f]["silent"]==true?true:false;boardId=d[f]["from"].replace(/_.*/,"");board=boardStorage.getBoard(boardId);board.move(lengthenFieldString(d[f]["from"]),lengthenFieldString(d[f]["to"]),d[f]["toPiece"],silent);parseCurrPlayer(d[f]["currP"]);break;case"movehist":addServerMessage(d[f]["user"]+" played <b>"+d[f]["str"]+"</b>");break;case"promote":var k=$("<div>").html("Select which piece to promote to:<br/><br/>");for(elem in d[f]["options"]){piece=d[f]["options"][elem];board=boardStorage.getBoard(boardId);pieceDiv=board.getPieceDiv(piece).addClass("promotion_piece");pieceDiv.bind("click",{Param1:d[f]["from"],Param2:d[f]["to"],Param3:piece},function(e){postMove(e.data.Param1,e.data.Param2,e.data.Param3);$.modal.close()});k.append(pieceDiv)}k.modal();break;case"chat":addChatMessage(d[f]["user"],decodeURIComponent(d[f]["msg"]));playSound("media/chat-message");break;case"gameover":goMsg="Game finished.\nResult: "+d[f]["result"]+"\n"+d[f]["msg"];addServerMessage(goMsg);setTimeout(function(){alert(goMsg)},1000);break;case"gamesit":var c=-1;while(true){c++;try{var h=d[f][c]["board_id"]}catch(g){break}boardId=d[f][c]["board_id"];if(d[f][c]["board_size"]!=undefined){boardSize=d[f][c]["board_size"].split("x");board=boardStorage.newBoard(boardId,boardSize[0],boardSize[1],d[f][c]["flipped"]);board.loadFEN(d[f][c]["fen"]);board.highlight_clear();if(d[f][c]["lmove_from"]!=undefined&&d[f][c]["lmove_to"]!=undefined){board.highlight_move(lengthenFieldString(d[f][c]["lmove_from"]),lengthenFieldString(d[f][c]["lmove_to"]))}}if(d[f][c]["pockets"]!=undefined){pockets=d[f][c]["pockets"].split(",");var l=d[f][c]["flipped"];var b=boardStorage.getBoard(boardId);window.setTimeout(function(){_fillPocket("top",pockets[l?0:1],b);_fillPocket("bottom",pockets[l?1:0],b)},1000)}if(d[f][c]["capturePockets"]!=undefined){}}parseCurrPlayer(d[f]["currP"]);break;case"srvmsg":addServerMessage(d[f]["msg"]);break;case"draw-offer":var a=confirm("Your opponent is offering a draw. Do you accept?");if(a){serverCall("end/"+mqId+"/draw-offer",undefined,true,false)}break;case"alert":alert(d[f]["msg"]);break}lastParsedMsg=d[f]["mid"];_debug("parsed message with id "+lastParsedMsg,4)}}function isArray(a){return(typeof(a.length)=="undefined")?false:true};